<!DOCTYPE html>
<html lang="en"><head><title>Use a Raspberry Pi 4B as hacking accessory :: Cardboard Iguana Security</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto Sans:wght@400;700&amp;family=Noto Sans:ital,wght@0,400;0,600;1,400;1,600&amp;family=Noto Sans Mono:wght@400;600&amp;display=swap"/><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="Cardboard Iguana Security"/><meta property="og:title" content="Use a Raspberry Pi 4B as hacking accessory :: Cardboard Iguana Security"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Use a Raspberry Pi 4B as hacking accessory :: Cardboard Iguana Security"/><meta name="twitter:description" content="This guide will cover setting up Kali Linux on a Raspberry Pi 4B so that: It can be used as a USB C “gadget” with an iPad Pro (or similar device); All files except for /boot are encrypted; A full desktop environment is available on demand via RDP; and The system still works as a desktop device in a ..."/><meta property="og:description" content="This guide will cover setting up Kali Linux on a Raspberry Pi 4B so that: It can be used as a USB C “gadget” with an iPad Pro (or similar device); All files except for /boot are encrypted; A full desktop environment is available on demand via RDP; and The system still works as a desktop device in a ..."/><meta property="og:image:alt" content="This guide will cover setting up Kali Linux on a Raspberry Pi 4B so that: It can be used as a USB C “gadget” with an iPad Pro (or similar device); All files except for /boot are encrypted; A full desktop environment is available on demand via RDP; and The system still works as a desktop device in a ..."/><meta property="og:image" content="https://cardboard-iguana.com/grimoire/static/og-image.png"/><meta property="og:image:url" content="https://cardboard-iguana.com/grimoire/static/og-image.png"/><meta name="twitter:image" content="https://cardboard-iguana.com/grimoire/static/og-image.png"/><meta property="og:image:type" content="image/.png"/><meta property="twitter:domain" content="cardboard-iguana.com/grimoire"/><meta property="og:url" content="https://cardboard-iguana.com/grimoire/spells/Use-a-Raspberry-Pi-4B-as-hacking-accessory"/><meta property="twitter:url" content="https://cardboard-iguana.com/grimoire/spells/Use-a-Raspberry-Pi-4B-as-hacking-accessory"/><link rel="icon" href="../static/icon.png"/><meta name="description" content="This guide will cover setting up Kali Linux on a Raspberry Pi 4B so that: It can be used as a USB C “gadget” with an iPad Pro (or similar device); All files except for /boot are encrypted; A full desktop environment is available on demand via RDP; and The system still works as a desktop device in a ..."/><meta name="generator" content="Quartz"/><link href="../index.css" rel="stylesheet" type="text/css" spa-preserve/><style>.expand-button {
  position: absolute;
  display: flex;
  float: right;
  padding: 0.4rem;
  margin: 0.3rem;
  right: 0;
  color: var(--gray);
  border-color: var(--dark);
  background-color: var(--light);
  border: 1px solid;
  border-radius: 5px;
  opacity: 0;
  transition: 0.2s;
}
.expand-button > svg {
  fill: var(--light);
  filter: contrast(0.3);
}
.expand-button:hover {
  cursor: pointer;
  border-color: var(--secondary);
}
.expand-button:focus {
  outline: 0;
}

pre:hover > .expand-button {
  opacity: 1;
  transition: 0.2s;
}

#mermaid-container {
  position: fixed;
  contain: layout;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  display: none;
  backdrop-filter: blur(4px);
  background: rgba(0, 0, 0, 0.5);
}
#mermaid-container.active {
  display: inline-block;
}
#mermaid-container > #mermaid-space {
  border: 1px solid var(--lightgray);
  background-color: var(--light);
  border-radius: 5px;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  height: 80vh;
  width: 80vw;
  overflow: hidden;
}
#mermaid-container > #mermaid-space > .mermaid-content {
  padding: 2rem;
  position: relative;
  transform-origin: 0 0;
  transition: transform 0.1s ease;
  overflow: visible;
  min-height: 200px;
  min-width: 200px;
}
#mermaid-container > #mermaid-space > .mermaid-content pre {
  margin: 0;
  border: none;
}
#mermaid-container > #mermaid-space > .mermaid-content svg {
  max-width: none;
  height: auto;
}
#mermaid-container > #mermaid-space > .mermaid-controls {
  position: absolute;
  bottom: 20px;
  right: 20px;
  display: flex;
  gap: 8px;
  padding: 8px;
  background: var(--light);
  border: 1px solid var(--lightgray);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 2;
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  padding: 0;
  border: 1px solid var(--lightgray);
  background: var(--light);
  color: var(--dark);
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  font-family: var(--bodyFont);
  transition: all 0.2s ease;
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:hover {
  background: var(--lightgray);
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:active {
  transform: translateY(1px);
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:nth-child(2) {
  width: auto;
  padding: 0 12px;
  font-size: 14px;
}
/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VSb290IjoiL1VzZXJzL25lY29waW51cy9SZXBvcy9jYXJkYm9hcmQtaWd1YW5hLmNvbS9idWlsZC9xdWFydHovcXVhcnR6L2NvbXBvbmVudHMvc3R5bGVzIiwic291cmNlcyI6WyJtZXJtYWlkLmlubGluZS5zY3NzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTtFQUNBOztBQUdGO0VBQ0U7RUFDQTs7QUFHRjtFQUNFOzs7QUFLRjtFQUNFO0VBQ0E7OztBQUlKO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFOztBQUdGO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFO0VBQ0E7O0FBR0Y7RUFDRTtFQUNBOztBQUlKO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTs7QUFHRjtFQUNFOztBQUlGO0VBQ0U7RUFDQTtFQUNBIiwic291cmNlc0NvbnRlbnQiOlsiLmV4cGFuZC1idXR0b24ge1xuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIGRpc3BsYXk6IGZsZXg7XG4gIGZsb2F0OiByaWdodDtcbiAgcGFkZGluZzogMC40cmVtO1xuICBtYXJnaW46IDAuM3JlbTtcbiAgcmlnaHQ6IDA7IC8vIE5PVEU6IHJpZ2h0IHdpbGwgYmUgc2V0IGluIG1lcm1haWQuaW5saW5lLnRzXG4gIGNvbG9yOiB2YXIoLS1ncmF5KTtcbiAgYm9yZGVyLWNvbG9yOiB2YXIoLS1kYXJrKTtcbiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbGlnaHQpO1xuICBib3JkZXI6IDFweCBzb2xpZDtcbiAgYm9yZGVyLXJhZGl1czogNXB4O1xuICBvcGFjaXR5OiAwO1xuICB0cmFuc2l0aW9uOiAwLjJzO1xuXG4gICYgPiBzdmcge1xuICAgIGZpbGw6IHZhcigtLWxpZ2h0KTtcbiAgICBmaWx0ZXI6IGNvbnRyYXN0KDAuMyk7XG4gIH1cblxuICAmOmhvdmVyIHtcbiAgICBjdXJzb3I6IHBvaW50ZXI7XG4gICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1zZWNvbmRhcnkpO1xuICB9XG5cbiAgJjpmb2N1cyB7XG4gICAgb3V0bGluZTogMDtcbiAgfVxufVxuXG5wcmUge1xuICAmOmhvdmVyID4gLmV4cGFuZC1idXR0b24ge1xuICAgIG9wYWNpdHk6IDE7XG4gICAgdHJhbnNpdGlvbjogMC4ycztcbiAgfVxufVxuXG4jbWVybWFpZC1jb250YWluZXIge1xuICBwb3NpdGlvbjogZml4ZWQ7XG4gIGNvbnRhaW46IGxheW91dDtcbiAgei1pbmRleDogOTk5O1xuICBsZWZ0OiAwO1xuICB0b3A6IDA7XG4gIHdpZHRoOiAxMDB2dztcbiAgaGVpZ2h0OiAxMDB2aDtcbiAgb3ZlcmZsb3c6IGhpZGRlbjtcbiAgZGlzcGxheTogbm9uZTtcbiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7XG4gIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC41KTtcblxuICAmLmFjdGl2ZSB7XG4gICAgZGlzcGxheTogaW5saW5lLWJsb2NrO1xuICB9XG5cbiAgJiA+ICNtZXJtYWlkLXNwYWNlIHtcbiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1saWdodGdyYXkpO1xuICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWxpZ2h0KTtcbiAgICBib3JkZXItcmFkaXVzOiA1cHg7XG4gICAgcG9zaXRpb246IGZpeGVkO1xuICAgIHRvcDogNTAlO1xuICAgIGxlZnQ6IDUwJTtcbiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTtcbiAgICBoZWlnaHQ6IDgwdmg7XG4gICAgd2lkdGg6IDgwdnc7XG4gICAgb3ZlcmZsb3c6IGhpZGRlbjtcblxuICAgICYgPiAubWVybWFpZC1jb250ZW50IHtcbiAgICAgIHBhZGRpbmc6IDJyZW07XG4gICAgICBwb3NpdGlvbjogcmVsYXRpdmU7XG4gICAgICB0cmFuc2Zvcm0tb3JpZ2luOiAwIDA7XG4gICAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xcyBlYXNlO1xuICAgICAgb3ZlcmZsb3c6IHZpc2libGU7XG4gICAgICBtaW4taGVpZ2h0OiAyMDBweDtcbiAgICAgIG1pbi13aWR0aDogMjAwcHg7XG5cbiAgICAgIHByZSB7XG4gICAgICAgIG1hcmdpbjogMDtcbiAgICAgICAgYm9yZGVyOiBub25lO1xuICAgICAgfVxuXG4gICAgICBzdmcge1xuICAgICAgICBtYXgtd2lkdGg6IG5vbmU7XG4gICAgICAgIGhlaWdodDogYXV0bztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAmID4gLm1lcm1haWQtY29udHJvbHMge1xuICAgICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgICAgYm90dG9tOiAyMHB4O1xuICAgICAgcmlnaHQ6IDIwcHg7XG4gICAgICBkaXNwbGF5OiBmbGV4O1xuICAgICAgZ2FwOiA4cHg7XG4gICAgICBwYWRkaW5nOiA4cHg7XG4gICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1saWdodCk7XG4gICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1saWdodGdyYXkpO1xuICAgICAgYm9yZGVyLXJhZGl1czogNnB4O1xuICAgICAgYm94LXNoYWRvdzogMCAycHggNHB4IHJnYmEoMCwgMCwgMCwgMC4xKTtcbiAgICAgIHotaW5kZXg6IDI7XG5cbiAgICAgIC5tZXJtYWlkLWNvbnRyb2wtYnV0dG9uIHtcbiAgICAgICAgZGlzcGxheTogZmxleDtcbiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjtcbiAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7XG4gICAgICAgIHdpZHRoOiAzMnB4O1xuICAgICAgICBoZWlnaHQ6IDMycHg7XG4gICAgICAgIHBhZGRpbmc6IDA7XG4gICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWxpZ2h0Z3JheSk7XG4gICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWxpZ2h0KTtcbiAgICAgICAgY29sb3I6IHZhcigtLWRhcmspO1xuICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7XG4gICAgICAgIGN1cnNvcjogcG9pbnRlcjtcbiAgICAgICAgZm9udC1zaXplOiAxNnB4O1xuICAgICAgICBmb250LWZhbWlseTogdmFyKC0tYm9keUZvbnQpO1xuICAgICAgICB0cmFuc2l0aW9uOiBhbGwgMC4ycyBlYXNlO1xuXG4gICAgICAgICY6aG92ZXIge1xuICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWxpZ2h0Z3JheSk7XG4gICAgICAgIH1cblxuICAgICAgICAmOmFjdGl2ZSB7XG4gICAgICAgICAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDFweCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTdHlsZSB0aGUgcmVzZXQgYnV0dG9uIGRpZmZlcmVudGx5XG4gICAgICAgICY6bnRoLWNoaWxkKDIpIHtcbiAgICAgICAgICB3aWR0aDogYXV0bztcbiAgICAgICAgICBwYWRkaW5nOiAwIDEycHg7XG4gICAgICAgICAgZm9udC1zaXplOiAxNHB4O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0= */</style><script src="../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../static/contentIndex.json").then(data => data.json())</script><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://cardboard-iguana.com/grimoire/index.xml"/></head><body data-slug="spells/Use-a-Raspberry-Pi-4B-as-hacking-accessory"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"></div><div class="center"><div class="page-header"><header><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="..">Cardboard Iguana Security</a><p> / </p></div><div class="breadcrumb-element"><a href="../spells">spells</a><p> / </p></div><div class="breadcrumb-element"><a href>Use a Raspberry Pi 4B as hacking accessory</a></div></nav></header><div class="popover-hint"><p show-comma="true" class="content-meta"><time datetime="2025-06-14T22:37:21.816Z">Saturday, June 14, 2025</time><span>18 min read</span></p><ul class="tags"><li><a href="../tags/HowTo" class="internal tag-link">HowTo</a></li><li><a href="../tags/Hardware/RaspberryPi/4B" class="internal tag-link">Hardware/RaspberryPi/4B</a></li><li><a href="../tags/OS/Linux/Distros/Kali" class="internal tag-link">OS/Linux/Distros/Kali</a></li><li><a href="../tags/Application/MicrosoftRemoteDesktop" class="internal tag-link">Application/MicrosoftRemoteDesktop</a></li><li><a href="../tags/Application/SSH/Dropbear" class="internal tag-link">Application/SSH/Dropbear</a></li><li><a href="../tags/Application/JumpDesktop" class="internal tag-link">Application/JumpDesktop</a></li><li><a href="../tags/Hardware/iPadPro" class="internal tag-link">Hardware/iPadPro</a></li></ul></div></div><article class="popover-hint"><p>This guide will cover setting up <a href="https://www.kali.org/" class="external" target="_blank">Kali Linux<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> on a <a href="https://www.raspberrypi.org/products/raspberry-pi-4-model-b/" class="external" target="_blank">Raspberry Pi 4B<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> so that:</p>
<ul>
<li>It can be used as a USB C “gadget” with an <a href="https://www.apple.com/ipad-pro/" class="external" target="_blank">iPad Pro<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> (or similar device);</li>
<li>All files except for /boot are encrypted;</li>
<li>A full desktop environment is available on demand via RDP; and</li>
<li>The system <em>still</em> works as a desktop device in a pinch (BYO keyboard, mouse, and monitor).</li>
</ul>
<p>Be aware that this guide was written using the 64-bit 2021.2 Kali Linux image; YMMV with other images!</p>
<p>It should be possible to adapt the steps here for other Debian-based operating systems with a Raspberry Pi 4B compatible image. It should <em>also</em> be possible to do this all in fewer steps; the guide below is split up in a very step-by-step fashion, and is in no way optimized for speed.</p>
<h2 id="hardware-and-software">Hardware and software<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#hardware-and-software" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Things you’ll want/need:</p>
<ul>
<li>A Raspberry Pi. (I use an <a href="https://www.adafruit.com/product/4564" class="external" target="_blank">8 GB Raspberry Pi 4B<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>.)</li>
<li>A good USB C cable. (The <a href="https://www.amazon.com/dp/B07THFJ1J5" class="external" target="_blank">DockCase USB C cable<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> is surprisingly great.)</li>
<li>A good microSD card. (I use a <a href="https://www.kingston.com/en/memory-cards/canvas-go-plus-microsd-card" class="external" target="_blank">64 GB Kingston Canvass Go! Plus<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>.)</li>
<li>A second “bootstrap” microSD card that’s at least 32 GB in size. (You need something <em>twice</em> the size that your operating system image requires. This will just be used to “bootstrap” the encrypted microSD card, so it’s only necessary if you’re spinning the Pi up for the first time.)</li>
<li>A USB microSD card reader (since you’ll need to have <em>both</em> microSD cards connected to the Pi briefly.)</li>
<li>Physical access to a Linux system. (This could actually be the Pi itself, if you’ve already got it up and running with another operating system.)</li>
<li>An HDMI monitor, microHDMI-to-HDMI cable, and a USB keyboard (only needed until we set up network access and USB gadget mode).</li>
</ul>
<h2 id="create-the-bootstrap-microsd-if-necessary">Create the bootstrap microSD (if necessary)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#create-the-bootstrap-microsd-if-necessary" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>If you’re setting the Pi up for the first time, you’ll need to burn a Kali Linux microSD card to bootstrap off of. (If you already have a working Pi, then this can be skipped.)</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Download the latest version of Kali Linux from</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># https://www.kali.org/get-kali/#kali-arm. Check that page to</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># see which file name you should be using here (2021.2 is</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># current at the time of this writing).</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -O</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://images.kali.org/arm-images/kali-linux-2021.2-rpi4-nexmon-64.img.xz</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Check the sha256 hash to make sure you've downloaded a good</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># file (the hash used below is for the 2021.2 image).</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sha256sum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kali-linux-2021.2-rpi4-nexmon-64.img.xz</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -E</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;^97549d9e24dbd73add004b9521874dff6351a6275428356e804b98eb9e842c99 &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;SUCCESS - Download checksum looks good&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;FAILURE - Download checksum doesn't match expected value; file corrupt or incorrect&quot;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /dev/mmcblk0 is the SD card device on my system; YMMV. Be</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># sure to use the right device here, or you can hose your</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># system! If your system automatically mounts partitions on</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># insert, then you'll need to unmount them before performing</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># this step.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">xzcat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kali-linux-2021.2-rpi4-nexmon-64.img.xz</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of=/dev/mmcblk0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bs=4M</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status=progress</span></span></code></pre></figure>
<p>There’s a small amount of free space on the Kali ROOTFS partition; it may be useful to drop any of the <a href="../spells/SSH" class="internal" data-slug="spells/SSH">SSH</a> private keys here that you’ll eventually want to use to use to log into the Pi here to make it easier to copy them into the right locations later.</p>
<p>Pop the microSD card out, throw it in your Pi, boot up, log in. <a href="https://www.kali.org/docs/introduction/default-credentials/" class="external" target="_blank">The first-run username and password are both kali.<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></p>
<p>We’ll need more space in ROOTFS than the Kali image provides out-of-the-box. The kalipi-config tool can make this happen, but unfortunately it doesn’t recognize the the 64-bit images as a Raspberry Pi! To fix this, you’ll need to edit /usr/bin/kalipi-config and hack the <code>is_pi()</code> function so that it always returns 0. Once you’ve done this, run <a href="https://raspberrypi.stackexchange.com/questions/46520/expand-file-system-kali-linux-on-sd-card-of-16gb/127378#127378" class="external" target="_blank"><code>sudo kalipi-config</code><svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> and use <strong>Advanced Options > Expand Filesystem</strong> to reclaim the rest of your microSD card’s space.</p>
<p>You’re now ready to bootstrap your <em>actual</em> system!</p>
<h2 id="set-up-the-encrypted-microsd-sard">Set up the encrypted microSD sard<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#set-up-the-encrypted-microsd-sard" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Download the latest version of Kali Linux from</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># https://www.kali.org/get-kali/#kali-arm. Check that page to</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># see which file name you should be using here (2021.2 is</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># current at the time of this writing).</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -O</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://images.kali.org/arm-images/kali-linux-2021.2-rpi4-nexmon-64.img.xz</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Check the sha256 hash to make sure you've downloaded a good</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># file (the hash used below is for the 2021.2 image).</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sha256sum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kali-linux-2021.2-rpi4-nexmon-64.img.xz</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -E</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;^97549d9e24dbd73add004b9521874dff6351a6275428356e804b98eb9e842c99 &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;SUCCESS - Download checksum looks good&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;FAILURE - Download checksum doesn't match expected value; file corrupt or incorrect&quot;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Decompress the image. Note that you may experience I/O hangs</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># while decompressing the image; just be patient and wait for</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># the Pi's little green light to stop flashing.)</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unxz</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kali-linux-2021.2-rpi4-nexmon-64.img.xz</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Everything from here on out needs to be run as root, so</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># let's use sudo to open a root shell now.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Mount the partitions in the Kali disk image. Your image</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># partitions will *probably* show up as /dev/loop0p1 and</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /dev/loop0p2, but you may want to check the symlinks under</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /dev/disk/by-label first, just to be sure.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">losetup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -Pf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kali-linux-2021.2-rpi4-nexmon-64.img</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/img-{root,boot}</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/loop0p1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/img-boot</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/loop0p2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/img-root</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Now connect up the microSD card reader and insert the first</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># microSD card and partition it. My card shows up as</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /dev/mmcblk1 (so that's what I'll be using moving forward),</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># but you'll want to double-check this; if you use the wrong</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># device here you can hose your system!</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Delete the current partition, make sure you're using a DOS</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># partition table, and then create two new partitions:</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># The first partition should be a primary partition 256MB in</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># size of type 0c (W95 FAT32 LBA).</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># The second partition should also be a primary partition. It</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># should use the remainder of the space and be of type 83</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># (Linux).</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fdisk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/mmcblk1</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Format the new partitions, mount them, and copy over the</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># operating system files.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkfs.vfat</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BOOT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/mmcblk1p1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cryptsetup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> luksFormat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/mmcblk1p2</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cryptsetup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> luksOpen</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/mmcblk1p2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> crypt_rootfs</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkfs.ext4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ROOTFS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/mapper/crypt_rootfs</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-{root,boot}</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/mmcblk1p1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-boot</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/mapper/crypt_rootfs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -avh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/img-boot/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-boot/</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsync</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -avh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/img-root/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># You should copy your SSH public key(s) over to /mnt/ext-root </span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># at this point, as you'll eventually need these to unlock the</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Kali ROOTFS partition via dropbear. I'm not writing out that</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># step explicitly though; you could be generating a new</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># keypair here, using keys you copied over to the bootstrap</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># microSD above, or just copying ~/.ssh/authorized_keys from</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># an existing system. You do you.</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Make the Pi load an initramfs on boot.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'initramfs initramfs.zst followkernel'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> >></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-boot/config.txt</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Make sure the kernel knows where ROOTFS is. Note that we use</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /dev/mmcblk0p2 here rather than /dev/mmcblk1p2, because</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># we're going to remove the current microSD card and use the</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># one we're creating in a moment, which means that on boot</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># this new card with be /dev/mmcblk0!</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 's#root=/dev/mmcblk0p2#root=/dev/mapper/crypt_rootfs cryptdevice=/dev/mmcblk0p2:crypt_rootfs#'</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-boot/cmdline.txt</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Fix paths in /etc/fstab.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 's#/dev/mmcblk0p2#/dev/mapper/crypt_rootfs#'</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/etc/fstab</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Add ROOTFS to /etc/crypttab.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'crypt_rootfs	/dev/mmcblk0p2	none	luks'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> >></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/etc/crypttab</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Now let's actually generate the initramfs we need. Note that</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># mkinitramfs wants a (missing) kernel config, so we copy one</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># over from linux-headers as a work-around.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> none</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/proc</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sysfs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> none</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/sys</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bind</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/dev</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bind</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/pts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/dev/pts</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bind</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-boot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/boot</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LANG</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">C</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> chroot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/src/linux-headers-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/.config</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   /boot/config-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkinitramfs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/initramfs.zst</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Cleanup our mess.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">umount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/boot</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">umount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/dev/pts</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">umount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/dev</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">umount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/sys</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">umount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root/proc</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">umount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-root</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cryptsetup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> luksClose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> crypt_rootfs</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">umount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-boot</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">umount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/img-root</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">umount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/img-boot</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">losetup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -D</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -rf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/ext-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /mnt/img-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span></code></pre></figure>
<p>Now comes the moment of truth: Shut down and unplug the Pi, remove the bootstrap microSD card and the reader, put the microSD card you just created (from the reader, with the encrypted ROOTFS) into the Pi, and then plug the Pi back in. If everything went right, you should be prompted to enter the decryption passphrase you set for the microSD card, after which boot will continue and you’ll be able to log into the desktop environment!</p>
<p>(Note that the console unlock message can sometimes get lost in the initial dmesg output.)</p>
<h2 id="first-boot">First boot<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#first-boot" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>After the first successful boot there’s some basic housekeeping that we should do.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Change the default user password.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">passwd</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Become root.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># System update. DPKG may ask you some questions during this</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># process.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> full-upgrade</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> autoremove</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --purge</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --autoremove</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clean</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Update the (missing) kernel config.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/src/linux-headers-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /lib/modules</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> '-Re4son-v8l+$'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sort</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/.config</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   /boot/config-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /lib/modules</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> '-Re4son-v8l+$'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sort</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Regenerate initramfs.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkinitramfs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/initramfs.zst</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /lib/modules</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> '-Re4son-v8l+$'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sort</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Drop permissions.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span></code></pre></figure>
<p>Kali Linux on the Raspberry Pi isn’t configured to use swap, which makes sense because normally it’s running from a slow microSD card. Still, having <a href="https://haydenjames.io/linux-performance-almost-always-add-swap-space/" class="external" target="_blank">some swap can aid system stability<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>. We’re going to split the baby by <a href="https://haydenjames.io/linux-performance-almost-always-add-swap-part2-zram/" class="external" target="_blank">enabling ZRAM<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>.</p>
<p>Begin by create /usr/local/sbin/zram.sh:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/usr/bin/bash</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> in</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;start&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> )</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		# The &quot;-s&quot; option sets the size of the ZRAM device</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		# *before* compression; ZRAM will *actually* use</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		# something closer to 30% - 50% of this value, depending</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		# on the compression algorithm used. As a rule of thumb,</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		# set &quot;-s&quot; to be equal to the amount of RAM you actually</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		# have *or* 8G, whichever is *less*.</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		ZRAMDEV</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">zramctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8G </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zstd)&quot;</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		mkswap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ZRAMDEV</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		swapon</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ZRAMDEV</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	;;</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;stop&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> )</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ZRAMDEV </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> '/zram/ { print $1 }'</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/swaps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">			swapoff</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ZRAMDEV</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">			zramctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ZRAMDEV</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		done</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	;;</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	&quot;restart&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> )</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">		$0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span></span>
<span data-line><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">		$0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	;;</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">	-</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> )</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;USAGE: $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">basename</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;) (start|stop|restart)&quot;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	;;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">esac</span></span></code></pre></figure>
<p>Then create the systemd service file /etc/systemd/system/zram.service:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Unit]</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=ZRAM-based virtual swap device</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Requires</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=systemd-modules-load.service</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Install]</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WantedBy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=sysinit.target</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Service]</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=oneshot</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ExecStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/usr/local/sbin/zram.sh start</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ExecStop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/usr/local/sbin/zram.sh stop</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RemainAfterExit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span></code></pre></figure>
<p>Finally, make sure that everything’s enabled.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Become root.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Make sure that the ZRAM module is loaded.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zram</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> >></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/modules</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Make the zram.sh script executable.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/sbin/zram.sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Enable required services.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> daemon-reload</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zram.service</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Encourage the kernel to preferentially clean up memory and</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># swap into ZRAM sooner.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'vm.vfs_cache_pressure=500'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> >></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/sysctl.conf</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'vm.swappiness=100'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> >></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/sysctl.conf</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'vm.dirty_background_ratio=1'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> >></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/sysctl.conf</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'vm.dirty_ratio=50'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> >></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/sysctl.conf</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Drop permissions.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span></code></pre></figure>
<p>You should reboot after doing all of this.</p>
<h2 id="network-access-and-usb-gadget-mode">Network access and USB gadget mode<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#network-access-and-usb-gadget-mode" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Become root.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Install pre-requisits.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dnsmasq</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Update firmware overlay and initramfs kernel modules.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'dtoverlay=dwc2'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> >></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/config.txt</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ''</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> >></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/initramfs-tools/modules</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dwc2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> >></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/initramfs-tools/modules</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Create /etc/network/interfaces.d/usb0.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/network/interfaces.d/usb0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EOF</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">auto usb0</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">allow-hotplug usb0</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">iface usb0 inet static</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	address 10.55.0.1</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	netmask 255.255.255.248</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Create /etc/dnsmasq.d/ipad.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/dnsmasq.d/ipad</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EOF</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">interface=usb0</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">dhcp-range=10.55.0.2,10.55.0.6,255.255.255.248,1h</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">dhcp-option=3</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">dhcp-option=6</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">dhcp-authoritative</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">leasefile-ro</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Regenerate initramfs.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkinitramfs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/initramfs.zst</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /lib/modules</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> '-Re4son-v8l+$'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sort</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Drop permissions.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span></code></pre></figure>
<p>Create /usr/local/sbin/usb0up.sh:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="sh" data-theme="github-light github-dark"><code data-language="sh" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modprobe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libcomposite</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/config/usb_gadget</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pi4 ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pi4</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pi4</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x1d6b</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> idVendor</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Linux Foundation</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x0104</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> idProduct</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Multifunction Composite Gadget</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x0100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bcdDevice</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # v1.0.0</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x0200</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bcdUSB</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # USB2</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0xef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bDeviceClass</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x02</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bDeviceSubClass</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x01</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bDeviceProtocol</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> strings/0x409</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  fedcba9876543211</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> strings/0x409/serialnumber</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'Kali Linux'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> strings/0x409/manufacturer</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'Kali Linux'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> strings/0x409/product</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configs/c.1/strings/0x409</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 'Config 1: ECM network'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configs/c.1/strings/0x409/configuration</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  250</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                    ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configs/c.1/MaxPower</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> functions/ecm.usb0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> '00:dc:c8:f7:75:14'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> functions/ecm.usb0/host_addr</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # HostPC</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> '00:dd:dc:eb:6d:a1'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> functions/ecm.usb0/dev_addr</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # BadUSB</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	ln</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> functions/ecm.usb0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configs/c.1/ecm.usb0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	udevadm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> settle</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	ls</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/class/udc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> UDC</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span></code></pre></figure>
<p>Create /usr/local/sbin/usb0down.sh:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="sh" data-theme="github-light github-dark"><code data-language="sh" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/config/usb_gadget</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pi4 ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pi4</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ''</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> UDC</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configs/c.1/ecm.usb0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	rmdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> functions/ecm.usb0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	rmdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configs/c.1/strings/0x409</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	rmdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configs/c.1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	rmdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> strings/0x409</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ..</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	rmdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pi4</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	rmmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb_f_ecm</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	rmmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> u_ether</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	rmmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libcomposite</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span></code></pre></figure>
<p>The usb0down.sh script is something you won’t find in <a href="https://www.hardill.me.uk/wordpress/2019/11/02/pi4-usb-c-gadget/" class="external" target="_blank">other tutorials<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> about setting up a Raspberry Pi in USB gadget mode. Those all focus on bringing the usb0 interface up - none cover how to tear it down successfully. Unfortunately, iPadOS 15 doesn’t like it when USB ethernet gadget goes partially down when exiting the initramfs (we’ll cover this part of things in the next section). To work around this, we need to have the ability to <a href="https://e2e.ti.com/support/processors-group/processors/f/processors-forum/627474/linux-am3352-dynamic-reconfiguration-of-usb-gadget" class="external" target="_blank">completely remove usb0 so that the device doesn’t exist at all when the initramfs terminates and normal userland takes over<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a>.</p>
<p>Now that we can bring usb0 <em>completely</em> up and down, let’s tie things together. Create the systemd service file /etc/systemd/system/usb0.service:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Unit]</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=Raspberry Pi USB C ethernet gadget mode</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Before</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=network.target NetworkManager.service dnsmasq.service</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Requires</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=systemd-modules-load.service</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Install]</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WantedBy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=sysinit.target</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[Service]</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=oneshot</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ExecStartPre</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/usr/local/sbin/usb0up.sh</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ExecStart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/usr/sbin/ifup usb0</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ExecStop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/usr/sbin/ifdown usb0</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ExecStopPost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=/usr/local/sbin/usb0down.sh</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RemainAfterExit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span></code></pre></figure>
<p>Finally, let’s activate everything.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Become root.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Make our usb0.sh script executable.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/sbin/usb0up.sh</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/sbin/usb0down.sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Enable required services.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> daemon-reload</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dnsmasq.service</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb0.service</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Drop permissions.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span></code></pre></figure>
<p>Second moment of truth: Shut down the system, remove the power, and connect the Pi to your iPad over USB C. The Pi should power on, and then shortly after you unlock the ROOTFS the iPad should be assigned an <a href="../spells/IPv4" class="internal" data-slug="spells/IPv4">IPv4</a> address via the ethernet device “Kali Linux”. You should then be able to <a href="../spells/SSH" class="internal" data-slug="spells/SSH">SSH</a> in as kali@10.55.0.1.</p>
<h2 id="rootfs-unlock-over-ssh">RootFS unlock over SSH<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#rootfs-unlock-over-ssh" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Become root.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Install dropbear + initramfs hooks.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dropbear-initramfs</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Align dropbear SSH host keys with OpenSSH. Normally this</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># isn't considered a best practice, but...</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     (1) We're only ever connecting to the Pi over usb0, not</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#         an open network (or, god forbid, the internet).</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     (2) We're actually going to take steps in a moment to</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#         MAKE SURE that (1) is true.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Since we're only connecting to the Pi via SSH over a SINGLE</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># cable, using a private IP address, and with SSH host keys</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># that are unique to this device, the danger of having these</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># keys disclosed in the event that someone got ahold of the</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Pi's microSD card seems minimal (after all, such an attacker</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># could just trojan the initramfs.zst directly).</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># (Note that you should make sure to set an EMPTY password</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># when using ssh-keygen to convert they keys to PEM format, as</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># dropbear doesn't support password-protected host keys.)</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/dropbear/initramfs</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dropbear_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_host_key</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/ssh/ssh_host_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SSH_KEY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh_host_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	DROPBEAR_KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$SSH_KEY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 's/ssh_host_\(.*\)_key/dropbear_\1_host_key/')&quot;</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	ssh-keygen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PEM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $SSH_KEY</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	dropbearconvert</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> openssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dropbear</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $SSH_KEY $DROPBEAR_KEY</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $SSH_KEY</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># At this point you'll need to add your SSH public keys to</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /etc/dropbear/initramfs/authorized_keys. I'm not writing out</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># this step explicitly though; you could be generating a new</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># keypair here, using keys you copied over when setting up the</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># encrypted microSD card, or just copying</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ~/.ssh/authorized_keys (and making sure that the permissions</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># are right!). You do you.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># That said!</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># As a fan of per-host keys I'm not in love with this step,</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># since it means that if I reset my iPad then I need an</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># external keyboard to unlock the Pi before I can copy over</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># the new public key. Unfortunately, I don't see any way to</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># support a password-based login (which I think is &quot;secure</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># enough&quot; in here for the same reason that I think that</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># re-using the SSH host keys is &quot;secure enough&quot; in this</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># particular context) without modifying dropbear's initramfs</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># setup hook (which I'd rather not do, as any changes will be</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># overwritten if the dropbear-initramfs package is updated).</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Add dropbear configuration options. In particular, for an</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># unlock of ROOTFS on successful login.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 's;^#DROPBEAR_OPTIONS=$;DROPBEAR_OPTIONS=&quot;-jks -c /usr/bin/cryptroot-unlock-ssh&quot;;'</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/dropbear/initramfs/config</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Drop permissions.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span></code></pre></figure>
<p>Create /usr/local/sbin/cryptroot-unlock-ssh.sh:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="sh" data-theme="github-light github-dark"><code data-language="sh" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ROOTFS_DEV</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">crypt_rootfs</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /dev/mapper/$ROOTFS_DEV ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /cryptroot/crypttab ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		ROOTFS_UID</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ROOTFS_DEV</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /cryptroot/crypttab </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cut</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ' ' </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-f</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`&quot;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	elif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /etc/crypttab ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		ROOTFS_UID</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ROOTFS_DEV</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/crypttab </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cut</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`&quot;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	else</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		exit</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	fi</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	/usr/sbin/cryptsetup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> luksOpen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ROOTFS_UID $ROOTFS_DEV &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">killall</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cryptroot</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span></code></pre></figure>
<p>Create /usr/share/initramfs-tools/hooks/cryptroot-unlock-ssh:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="sh" data-theme="github-light github-dark"><code data-language="sh" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PREREQ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prereqs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$PREREQ</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> in</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">	prereqs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">)</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		prereqs</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	;;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">esac</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/hooks-functions</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy_file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> script</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/sbin/cryptroot-unlock-ssh.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/bin/cryptroot-unlock-ssh</span></span></code></pre></figure>
<p>Create /usr/share/initramfs-tools/hooks/ipad:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="sh" data-theme="github-light github-dark"><code data-language="sh" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PREREQ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prereqs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$PREREQ</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> in</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">	prereqs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">)</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		prereqs</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	;;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">esac</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/hooks-functions</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">manual_add_modules</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dwc2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libcomposite</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb_f_ecm</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy_file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> script</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/sbin/usb0up.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/usb0up.sh</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy_file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> script</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/sbin/usb0down.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/usb0down.sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy_exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/dnsmasq</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy_file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/dnsmasq.d/ipad</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/dnsmasq.conf</span></span></code></pre></figure>
<p>Create /usr/share/initramfs-tools/scripts/init-top/ipad:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="sh" data-theme="github-light github-dark"><code data-language="sh" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PREREQ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;udev&quot;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prereqs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$PREREQ</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> in</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">	prereqs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">)</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		prereqs</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	;;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">esac</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /scripts/functions</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configfs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> none</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/config</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/usb0up.sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ipconfig</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;10.55.0.1:::255.255.255.248:kali:usb0&quot;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/sbin/dnsmasq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --local-service</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --user=root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --pid-file=/run/dnsmasq.pid</span></span></code></pre></figure>
<p>Create /usr/share/initramfs-tools/scripts/local-bottom/ipad:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="sh" data-theme="github-light github-dark"><code data-language="sh" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PREREQ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prereqs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$PREREQ</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> in</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">	prereqs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">)</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		prereqs</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	;;</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">esac</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /scripts/functions</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">kill</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -TERM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> `</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /run/dnsmasq.pid`</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> down</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> address</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> flush</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> flush</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/sbin/usb0down.sh</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">umount</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/config</span></span></code></pre></figure>
<p>Fix up permissions and finish setting things up:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Become root.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Make sure that new initramfs-tools scripts are executable.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/sbin/cryptroot-unlock-ssh.sh</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/hooks/cryptroot-ssh</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/hooks/ipad</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/scripts/init-top/ipad</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/share/initramfs-tools/scripts/local-bottom/ipad</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Regenerate initramfs.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkinitramfs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/initramfs.zst</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /lib/modules</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> '-Re4son-v8l+$'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sort</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tail</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Drop permissions.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span></code></pre></figure>
<p>Third moment of truth: Reboot your system. After a few moments you should be able to <a href="../spells/SSH" class="internal" data-slug="spells/SSH">SSH</a> into it as root@10.55.0.1 (over USB C) and be prompted to unlock your root device. After you type in your decryption passphrase, <a href="../spells/SSH" class="internal" data-slug="spells/SSH">SSH</a> should automatically close and your system should continue to boot. In a few more moments you should be able to <a href="../spells/SSH" class="internal" data-slug="spells/SSH">SSH</a> back in as kali@10.55.0.1.</p>
<p>You can <em>also</em> still unlock the system at the console, which is handy if you want to use the Pi as a stand-alone computer.</p>
<p>Note an annoying feature of this setup - you have to <a href="../spells/SSH" class="internal" data-slug="spells/SSH">SSH</a> in as <em>root</em> to do the initial unlock, but then will need to <a href="../spells/SSH" class="internal" data-slug="spells/SSH">SSH</a> in a second time as <em>kali</em> once the system is fully up. Partly, this is due to the fact that there’s not really a way to hand <a href="../spells/SSH" class="internal" data-slug="spells/SSH">SSH</a> off from the initram environment to the full system (this is why you have to log in once to unlock, and again to use the system once it’s fully up). Theoretically it should be possible to add a kali user to the initramfs, but doing so would require both the dropbear initramfs hooks to be modified (which, as previously mentioned, is fragile w.r.t. upgrades) and <em>a lot</em> more magic in generally than seems advisable.</p>
<h2 id="network-hardening">Network hardening<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#network-hardening" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Now that we’ve got the Pi working with our iPad, we’re going to lock down networking a bit</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Become root.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Limit SSH access to the kali user over usb0.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ></span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/ssh/sshd_config.d/lockdown.conf</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EOF</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">AllowUsers kali</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ListenAddress 10.55.0.1</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">PermitRootLogin no</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sshd.service</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Basic firewall.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gufw</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ufw.service</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deny</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> allow</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 0.0.0.0/0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 68</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 0.0.0.0/0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 67</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udp</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> allow</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.55.0.0/29</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10.55.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 22</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tcp</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Drop permissions.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span></code></pre></figure>
<p>If you’re going to be using this device covertly, you almost certainly also want to run <code>sudo systemctl disable NetworkManager.service</code> so that the Pi doesn’t attempt to immediately connect to whatever network you plug it into.</p>
<h2 id="remote-desktop">Remote desktop<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#remote-desktop" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Become root.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Install xrdp.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> xrdp</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Turn off &quot;new&quot; cursors, as this causes problems with some</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># RDP clients. This isn't necessary if you're using Microsoft</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Remote Desktop, but is required to avoid the cursor being</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># surrounded by a weird box on Jump Desktop. The trade-off</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># here is that the &quot;new&quot; cursors look really nice, while the</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># &quot;old&quot; cursors... Do not.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 's/^new_cursors=true$/new_cursors=false/'</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/xrdp/xrdp.ini</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Allow connections in over usb0.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> allow</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.55.0.0/29</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10.55.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> port</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3389</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proto</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tcp</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Enable xrdp.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> xrdp.service</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Drop permissions.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span></span></code></pre></figure>
<p>You should now be able to log in using RDP. Standard resolutions work well, but HiDPI/Retina is only marginally more responsive than a slideshow.</p>
<p>As with the dropbear configuration in the previous section, please do <em>not</em> set up RDP like I’m presenting here if you’re using a device that’s exposed to a larger network, or worse yet the internet as a whole. In the real world, RDP servers should <em>only</em> be accessible over <a href="../spells/SSH" class="internal" data-slug="spells/SSH">SSH</a>, a VPN, or some other secure wrapper - never exposed directly as we’re doing here. The reason we can get away with less is (again) because we’re <em>only</em> exposing RDP over the usb0 interface, and the <em>only</em> other device that ever lives on that network is the iPad.</p>
<blockquote class="callout tip" data-callout="tip">
<div class="callout-title">
                  <div class="callout-icon"></div>
                  <div class="callout-title-inner"><p>Tip</p></div>
                  
                </div>
<div class="callout-content">
<div class="callout-content-inner">
<p>I use <a href="https://apps.apple.com/us/app/jump-desktop-rdp-vnc-fluid/id364876095" class="external" target="_blank">Jump Desktop<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> as my RDP client, rather than <a href="https://apps.apple.com/us/app/remote-desktop-mobile/id714464092" class="external" target="_blank">Microsoft Remote Desktop<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> - while Microsoft’s offering is overall nicer, Jump Desktop is faster and will connect even when the iPad’s <a href="../spells/Wi-Fi" class="internal" data-slug="spells/Wi-Fi">Wi-Fi</a> is disconnected (Microsoft will refuse to connect if <a href="../spells/Wi-Fi" class="internal" data-slug="spells/Wi-Fi">Wi-Fi</a> is disabled, even though the Pi is accessible via USB ethernet!).</p>
</div>
</div>
</blockquote></article><hr/><div class="page-footer"><div class="backlinks"><h3>Backlinks</h3><ul id="list-0" class="overflow"><li><a href="../journals/2022-08-15" class="internal">Notes from HOPE and DEF CON</a></li><li><a href="../spells/Use-Burp-Suite-with-Firefox" class="internal">Use Burp Suite with Firefox</a></li><li class="overflow-end"></li></ul></div></div></div><div class="right sidebar"><div class="flex-component" style="flex-direction: row; flex-wrap: nowrap; gap: 1rem;"><div style="flex-grow: 1; flex-shrink: 1; flex-basis: auto; order: 0; align-self: center; justify-self: center;"><div class="search"><button class="search-button"><p>Search</p><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></button><div class="search-container"><div class="search-space"><input autocomplete="off" class="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div class="search-layout" data-preview="true"></div></div></div></div></div><div style="flex-grow: 0; flex-shrink: 1; flex-basis: auto; order: 0; align-self: center; justify-self: center;"><button class="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button></div></div><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div class="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false,&quot;enableRadial&quot;:false}"></div><button class="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div class="global-graph-outer"><div class="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.2,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true,&quot;enableRadial&quot;:true}"></div></div></div><div class="toc desktop-only"><button type="button" class="toc-header" aria-controls="toc-content" aria-expanded="true"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><ul class="toc-content overflow" id="list-1"><li class="depth-0"><a href="#hardware-and-software" data-for="hardware-and-software">Hardware and software</a></li><li class="depth-0"><a href="#create-the-bootstrap-microsd-if-necessary" data-for="create-the-bootstrap-microsd-if-necessary">Create the bootstrap microSD (if necessary)</a></li><li class="depth-0"><a href="#set-up-the-encrypted-microsd-sard" data-for="set-up-the-encrypted-microsd-sard">Set up the encrypted microSD sard</a></li><li class="depth-0"><a href="#first-boot" data-for="first-boot">First boot</a></li><li class="depth-0"><a href="#network-access-and-usb-gadget-mode" data-for="network-access-and-usb-gadget-mode">Network access and USB gadget mode</a></li><li class="depth-0"><a href="#rootfs-unlock-over-ssh" data-for="rootfs-unlock-over-ssh">RootFS unlock over SSH</a></li><li class="depth-0"><a href="#network-hardening" data-for="network-hardening">Network hardening</a></li><li class="depth-0"><a href="#remote-desktop" data-for="remote-desktop">Remote desktop</a></li><li class="overflow-end"></li></ul></div></div><footer class><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.5.1</a> © 2025</p><ul><li><a href="/">Home</a></li><li><a href="https://github.com/necopinus/resume/raw/main/resume.pdf">Resume</a></li><li><a href="/#contact">Contact</a></li><li><a href="/grimoire/index.xml">RSS Feed</a></li></ul></footer></div></div></body><script type="application/javascript">function n(){let t=this.parentElement;t.classList.toggle("is-collapsed");let e=t.getElementsByClassName("callout-content")[0];if(!e)return;let l=t.classList.contains("is-collapsed");e.style.gridTemplateRows=l?"0fr":"1fr"}function c(){let t=document.getElementsByClassName("callout is-collapsible");for(let e of t){let l=e.getElementsByClassName("callout-title")[0],s=e.getElementsByClassName("callout-content")[0];if(!l||!s)continue;l.addEventListener("click",n),window.addCleanup(()=>l.removeEventListener("click",n));let o=e.classList.contains("is-collapsed");s.style.gridTemplateRows=o?"0fr":"1fr"}}document.addEventListener("nav",c);
</script><script type="module">function f(i,e){if(!i)return;function r(o){o.target===this&&(o.preventDefault(),o.stopPropagation(),e())}function t(o){o.key.startsWith("Esc")&&(o.preventDefault(),e())}i?.addEventListener("click",r),window.addCleanup(()=>i?.removeEventListener("click",r)),document.addEventListener("keydown",t),window.addCleanup(()=>document.removeEventListener("keydown",t))}function y(i){for(;i.firstChild;)i.removeChild(i.firstChild)}var h=class{constructor(e,r){this.container=e;this.content=r;this.setupEventListeners(),this.setupNavigationControls(),this.resetTransform()}isDragging=!1;startPan={x:0,y:0};currentPan={x:0,y:0};scale=1;MIN_SCALE=.5;MAX_SCALE=3;cleanups=[];setupEventListeners(){let e=this.onMouseDown.bind(this),r=this.onMouseMove.bind(this),t=this.onMouseUp.bind(this),o=this.resetTransform.bind(this);this.container.addEventListener("mousedown",e),document.addEventListener("mousemove",r),document.addEventListener("mouseup",t),window.addEventListener("resize",o),this.cleanups.push(()=>this.container.removeEventListener("mousedown",e),()=>document.removeEventListener("mousemove",r),()=>document.removeEventListener("mouseup",t),()=>window.removeEventListener("resize",o))}cleanup(){for(let e of this.cleanups)e()}setupNavigationControls(){let e=document.createElement("div");e.className="mermaid-controls";let r=this.createButton("+",()=>this.zoom(.1)),t=this.createButton("-",()=>this.zoom(-.1)),o=this.createButton("Reset",()=>this.resetTransform());e.appendChild(t),e.appendChild(o),e.appendChild(r),this.container.appendChild(e)}createButton(e,r){let t=document.createElement("button");return t.textContent=e,t.className="mermaid-control-button",t.addEventListener("click",r),window.addCleanup(()=>t.removeEventListener("click",r)),t}onMouseDown(e){e.button===0&&(this.isDragging=!0,this.startPan={x:e.clientX-this.currentPan.x,y:e.clientY-this.currentPan.y},this.container.style.cursor="grabbing")}onMouseMove(e){this.isDragging&&(e.preventDefault(),this.currentPan={x:e.clientX-this.startPan.x,y:e.clientY-this.startPan.y},this.updateTransform())}onMouseUp(){this.isDragging=!1,this.container.style.cursor="grab"}zoom(e){let r=Math.min(Math.max(this.scale+e,this.MIN_SCALE),this.MAX_SCALE),t=this.content.getBoundingClientRect(),o=t.width/2,n=t.height/2,c=r-this.scale;this.currentPan.x-=o*c,this.currentPan.y-=n*c,this.scale=r,this.updateTransform()}updateTransform(){this.content.style.transform=`translate(${this.currentPan.x}px, ${this.currentPan.y}px) scale(${this.scale})`}resetTransform(){this.scale=1;let e=this.content.querySelector("svg");this.currentPan={x:e.getBoundingClientRect().width/2,y:e.getBoundingClientRect().height/2},this.updateTransform()}},C=["--secondary","--tertiary","--gray","--light","--lightgray","--highlight","--dark","--darkgray","--codeFont"],E;document.addEventListener("nav",async()=>{let e=document.querySelector(".center").querySelectorAll("code.mermaid");if(e.length===0)return;E||=await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.esm.min.mjs");let r=E.default,t=new WeakMap;for(let n of e)t.set(n,n.innerText);async function o(){for(let s of e){s.removeAttribute("data-processed");let a=t.get(s);a&&(s.innerHTML=a)}let n=C.reduce((s,a)=>(s[a]=window.getComputedStyle(document.documentElement).getPropertyValue(a),s),{}),c=document.documentElement.getAttribute("saved-theme")==="dark";r.initialize({startOnLoad:!1,securityLevel:"loose",theme:c?"dark":"base",themeVariables:{fontFamily:n["--codeFont"],primaryColor:n["--light"],primaryTextColor:n["--darkgray"],primaryBorderColor:n["--tertiary"],lineColor:n["--darkgray"],secondaryColor:n["--secondary"],tertiaryColor:n["--tertiary"],clusterBkg:n["--light"],edgeLabelBackground:n["--highlight"]}}),await r.run({nodes:e})}await o(),document.addEventListener("themechange",o),window.addCleanup(()=>document.removeEventListener("themechange",o));for(let n=0;n<e.length;n++){let v=function(){let g=l.querySelector("#mermaid-space"),m=l.querySelector(".mermaid-content");if(!m)return;y(m);let w=c.querySelector("svg").cloneNode(!0);m.appendChild(w),l.classList.add("active"),g.style.cursor="grab",u=new h(g,m)},M=function(){l.classList.remove("active"),u?.cleanup(),u=null},c=e[n],s=c.parentElement,a=s.querySelector(".clipboard-button"),d=s.querySelector(".expand-button"),p=window.getComputedStyle(a),L=a.offsetWidth+parseFloat(p.marginLeft||"0")+parseFloat(p.marginRight||"0");d.style.right=`calc(${L}px + 0.3rem)`,s.prepend(d);let l=s.querySelector("#mermaid-container");if(!l)return;let u=null;d.addEventListener("click",v),f(l,M),window.addCleanup(()=>{u?.cleanup(),d.removeEventListener("click",v)})}});
</script><script src="../postscript.js" type="module"></script></html>